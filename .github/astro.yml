# Sample workflow for building and deploying an Astro site to GitHub Pages
#
# To get started with Astro see: https://docs.astro.build/en/getting-started/
#
name: Deploy Astro site to Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: [main]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  BUILD_PATH: "." # default value when not using subfolders
  # BUILD_PATH: subfolder

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      # - name: Install pnpm
      #   uses: pnpm/action-setup@v4
      #   with:
      #     version: 10

      # - name: Install Node.js
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: 24
      #     cache: 'pnpm'
      
      # - run: pnpm install

      # - name: Build website
      #   run: pnpm run build-action

      - name: Install, build, and upload your site
        uses: withastro/action@v5
        with:
          # path: . # The root location of your Astro project inside the repository. (optional)
          node-version: 24 # The specific version of Node that should be used to build your site. Defaults to 20. (optional)
          package-manager: pnpm@latest # The Node package manager that should be used to install dependencies and build your site. Automatically detected based on your lockfile. (optional)
          out-dir: dist
      
      - name: Publish to Cloudflare Pages
        uses: cloudflare/pages-action@1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: 2912be6a535e3b3689c79b309484b433
          projectName: aria-dot-coffee
          directory: ./dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

